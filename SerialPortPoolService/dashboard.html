<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SerialPortPool Dashboard - Fixed</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 24px;
            margin: 16px 0;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .metric-card {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
        }
        
        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
            color: #4CAF50;
        }
        
        .log-viewer {
            height: 450px;
            overflow-y: auto;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Cascadia Code', 'Courier New', monospace;
            line-height: 1.6;
            font-size: 14px;
        }
        
        .log-line {
            margin: 4px 0;
            padding: 4px 8px;
            border-radius: 4px;
            border-left: 4px solid transparent;
        }
        
        .log-success { 
            color: #4CAF50; 
            border-left-color: #4CAF50;
            background: rgba(76, 175, 80, 0.1);
        }
        .log-warning { 
            color: #FF9800; 
            border-left-color: #FF9800;
            background: rgba(255, 152, 0, 0.1);
        }
        .log-error { 
            color: #f44336; 
            border-left-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }
        .log-info { 
            color: #2196F3; 
            border-left-color: #2196F3;
            background: rgba(33, 150, 243, 0.05);
        }
        
        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 16px;
            border-radius: 25px;
            font-size: 0.9em;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .controls {
            margin-bottom: 16px;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .controls select, .controls button, .controls input {
            padding: 10px 14px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: white;
            font-size: 14px;
        }
        
        .controls button {
            cursor: pointer;
            background: #2196F3;
            color: white;
            border: 1px solid #2196F3;
            transition: all 0.2s;
        }
        
        .controls button:hover {
            background: #1976D2;
            transform: translateY(-1px);
        }
        
        .controls button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        
        .status-running { background-color: #4CAF50; }
        .status-stopped { background-color: #f44336; }
        .status-unknown { background-color: #9E9E9E; }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .file-drop-zone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-drop-zone:hover,
        .file-drop-zone.dragover {
            border-color: #2196F3;
            background: rgba(33, 150, 243, 0.1);
        }
        
        .file-input-hidden {
            display: none;
        }
        
        .connection-status {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-bottom: 16px;
        }
        
        @media (max-width: 768px) {
            body { padding: 10px; }
            .status-grid { grid-template-columns: repeat(2, 1fr); }
            .controls { 
                flex-direction: column; 
                align-items: flex-start; 
            }
            .controls > * {
                width: 100%;
                margin-bottom: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="refresh-indicator">
        üîÑ Auto-refresh: <span id="refreshCounter">10</span>s | üìä <span id="logCount">0</span> logs
    </div>
    
    <div class="dashboard-container">
        <header>
            <h1>üöÄ SerialPortPool Dashboard - Fixed</h1>
            <div class="connection-status">
                <span class="status-indicator" id="serviceIndicator"></span>
                Status: <span id="serviceStatus">Initializing...</span>
            </div>
        </header>

        <!-- Service Overview -->
        <div class="card">
            <h2>üìä Service Overview</h2>
            <div class="status-grid">
                <div class="metric-card">
                    <h3>BIB Executions</h3>
                    <div class="metric-value" id="totalExecutions">-</div>
                    <small>Total processed</small>
                </div>
                <div class="metric-card">
                    <h3>Success Rate</h3>
                    <div class="metric-value" id="successRate">-</div>
                    <small>Latest executions</small>
                </div>
                <div class="metric-card">
                    <h3>Active BIBs</h3>
                    <div class="metric-value" id="activeBibs">-</div>
                    <small>Currently running</small>
                </div>
                <div class="metric-card">
                    <h3>Last Activity</h3>
                    <div class="metric-value" id="lastActivity" style="font-size: 1.8em;">-</div>
                    <small>Minutes ago</small>
                </div>
            </div>
        </div>

        <!-- Log File Loader -->
        <div class="card">
            <h2>üìÅ Log File Loader</h2>
            <div class="controls">
                <button onclick="loadSampleData()">Load Sample Data</button>
                <button onclick="clearAllLogs()">Clear All</button>
                <button onclick="connectToRealService()" id="connectBtn">Connect to Service</button>
            </div>
            
            <div class="file-drop-zone" onclick="openFileDialog()">
                üìÇ Click to select log files or drop them here<br>
                <small>Supports .log, .txt files from BibUutLogger</small>
                <input type="file" id="fileInput" class="file-input-hidden" multiple accept=".log,.txt" />
            </div>
            
            <div id="fileStatus" style="margin-top: 10px; font-size: 0.9em; color: #666;"></div>
        </div>

        <!-- Live Logs Analysis -->
        <div class="card">
            <h2>üìã Log Analysis & Monitoring</h2>
            <div class="controls">
                <select id="bibFilter" onchange="filterLogs()">
                    <option value="all">All BIBs</option>
                </select>
                <select id="uutFilter" onchange="filterLogs()">
                    <option value="all">All UUTs</option>
                </select>
                <select id="logLevel" onchange="filterLogs()">
                    <option value="all">All Levels</option>
                    <option value="Information">Info</option>
                    <option value="Warning">Warning</option>
                    <option value="Error">Error</option>
                    <option value="Critical">Critical</option>
                </select>
                <button onclick="clearFilteredLogs()">Clear</button>
                <button onclick="toggleAutoRefresh()" id="refreshBtn">Pause</button>
                <button onclick="exportLogs()">Export</button>
            </div>
            <div class="log-viewer" id="liveLogs">
                <div class="log-line log-info">üîç SerialPortPool Dashboard Ready</div>
                <div class="log-line log-info">üìÇ Load sample data or select log files to begin analysis</div>
            </div>
        </div>
    </div>

    <script>
        // üîß Fixed Dashboard Logic - No window.fs dependencies
        let autoRefreshEnabled = true;
        let refreshCounter = 10;
        let allLogLines = []; // Store all logs
        let filteredLogLines = []; // Store filtered logs  
        let maxLogLines = 200;
        let availableBibs = new Set();
        let availableUuts = new Set();
        let serviceConnected = false;
        let simulationTimer = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ SerialPortPool Dashboard Starting...');
            
            // Setup file input handler
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', handleFileSelect);
            
            // Setup drag and drop
            setupDragAndDrop();
            
            // Start refresh timer
            startAutoRefreshTimer();
            
            // Initial status
            updateServiceStatusIndicator('unknown', 'Dashboard ready - load data or connect to service');
            
            console.log('‚úÖ Dashboard initialized successfully');
        });

        // üîÑ Auto-refresh timer
        function startAutoRefreshTimer() {
            setInterval(function() {
                if (autoRefreshEnabled) {
                    refreshCounter--;
                    document.getElementById('refreshCounter').textContent = refreshCounter;
                    
                    if (refreshCounter <= 0) {
                        if (serviceConnected) {
                            refreshServiceData();
                        } else {
                            simulateActivity();
                        }
                        refreshCounter = 10;
                    }
                }
            }, 1000);
        }

        // üìÇ File handling - FIXED VERSION
        function openFileDialog() {
            document.getElementById('fileInput').click();
        }

        function handleFileSelect(event) {
            const files = event.target.files;
            if (files && files.length > 0) {
                processLogFiles(Array.from(files));
            }
        }

        function setupDragAndDrop() {
            const dropZone = document.querySelector('.file-drop-zone');
            
            dropZone.addEventListener('dragover', function(e) {
                e.preventDefault();
                dropZone.classList.add('dragover');
            });
            
            dropZone.addEventListener('dragleave', function(e) {
                e.preventDefault();
                dropZone.classList.remove('dragover');
            });
            
            dropZone.addEventListener('drop', function(e) {
                e.preventDefault();
                dropZone.classList.remove('dragover');
                
                const files = Array.from(e.dataTransfer.files);
                if (files.length > 0) {
                    processLogFiles(files);
                }
            });
        }

        // üìÑ Process log files using FileReader API (WORKS IN ALL BROWSERS)
        function processLogFiles(files) {
            updateFileStatus(`üìÑ Processing ${files.length} file(s)...`);
            
            let processedFiles = 0;
            let totalLines = 0;
            
            files.forEach(function(file, index) {
                if (file.name.endsWith('.log') || file.name.endsWith('.txt')) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        const content = e.target.result;
                        const lines = content.split('\n').filter(line => line.trim());
                        
                        lines.forEach(function(line) {
                            if (line.trim() && !allLogLines.includes(line)) {
                                allLogLines.push(line);
                                totalLines++;
                            }
                        });
                        
                        processedFiles++;
                        if (processedFiles === files.length) {
                            updateFileStatus(`‚úÖ Loaded ${totalLines} log lines from ${files.length} file(s)`);
                            extractFiltersFromLogs();
                            filterLogs(); // Apply current filters
                            updateMetricsFromLogs();
                            updateServiceStatusIndicator('running', `Processing ${totalLines} log entries`);
                        }
                    };
                    
                    reader.onerror = function() {
                        updateFileStatus(`‚ùå Error reading ${file.name}`);
                    };
                    
                    reader.readAsText(file);
                } else {
                    processedFiles++;
                    updateFileStatus(`‚ö†Ô∏è Skipped ${file.name} (not a log file)`);
                }
            });
        }

        // üìä Sample data loader - IMPROVED
        function loadSampleData() {
            const sampleLogs = [
                '[14:30:05.123] [Information] ‚úÖ client_demo/production_uut üöÄ WORKFLOW STARTING: ENHANCED_CLIENT_CYCLE_1',
                '[14:30:06.145] [Information] ‚úÖ client_demo/production_uut START: INIT ‚Üí READY (PASS) [2.1s]', 
                '[14:30:08.267] [Information] ‚úÖ client_demo/production_uut TEST: TEST ‚Üí PASS (PASS) [1.8s]',
                '[14:30:09.891] [Information] ‚úÖ client_demo/production_uut STOP: QUIT ‚Üí BYE (PASS) [0.9s]',
                '[14:30:10.123] [Information] ‚úÖ client_demo/production_uut ‚úÖ COMPLETE: Workflow SUCCESS - 3 commands in 4.8s',
                '[14:35:12.456] [Information] ‚úÖ production_test_v2/test_board üöÄ WORKFLOW STARTING: ENHANCED_CLIENT_CYCLE_2',
                '[14:35:13.789] [Warning] ‚ö†Ô∏è production_test_v2/test_board TEST: Response slower than expected [3.2s]',
                '[14:35:16.123] [Information] ‚úÖ production_test_v2/test_board ‚úÖ COMPLETE: Workflow SUCCESS - 3 commands in 3.7s',
                '[14:40:20.456] [Error] ‚ùå client_demo/production_uut START: INIT timeout after 5s (FAIL)',
                '[14:40:25.789] [Error] ‚ùå client_demo/production_uut üí• WORKFLOW EXCEPTION: Port not responding',
                '[14:45:01.234] [Critical] üö® production_test_v2/test_board CRITICAL: Hardware fault detected',
                '[14:45:02.567] [Information] ‚úÖ system_diagnostics/internal_test üîç DIAGNOSTIC: Running system health check',
                '[14:45:05.890] [Information] ‚úÖ system_diagnostics/internal_test ‚úÖ DIAGNOSTIC COMPLETE: All systems nominal'
            ];

            allLogLines = [...sampleLogs];
            extractFiltersFromLogs();
            filterLogs();
            updateMetricsFromLogs();
            updateServiceStatusIndicator('running', 'Sample data loaded successfully');
            updateFileStatus('üìä Sample data loaded - 13 log entries');
            
            // Start sample activity simulation
            startSampleSimulation();
        }

        // üé≠ Sample activity simulation
        function startSampleSimulation() {
            if (simulationTimer) clearInterval(simulationTimer);
            
            const sampleActivities = [
                '[{time}] [Information] ‚úÖ client_demo/production_uut üöÄ WORKFLOW STARTING: CLIENT_CYCLE_AUTO',
                '[{time}] [Information] ‚úÖ test_station_1/board_test START: INIT ‚Üí READY (PASS) [{duration}s]',
                '[{time}] [Warning] ‚ö†Ô∏è client_demo/production_uut TEST: Slow response detected [{duration}s]',
                '[{time}] [Information] ‚úÖ production_test_v2/test_board ‚úÖ COMPLETE: Workflow SUCCESS',
                '[{time}] [Information] ‚úÖ system_monitor/health_check üîç System health: All ports functional'
            ];

            simulationTimer = setInterval(function() {
                if (autoRefreshEnabled && allLogLines.length > 0) {
                    const now = new Date();
                    const timeStr = now.toTimeString().slice(0, 12);
                    const duration = (Math.random() * 3 + 1).toFixed(1);
                    
                    const activity = sampleActivities[Math.floor(Math.random() * sampleActivities.length)]
                        .replace('{time}', timeStr)
                        .replace('{duration}', duration);
                    
                    allLogLines.push(activity);
                    
                    // Keep reasonable size
                    if (allLogLines.length > maxLogLines * 2) {
                        allLogLines = allLogLines.slice(-maxLogLines);
                    }
                    
                    extractFiltersFromLogs();
                    filterLogs();
                    updateMetricsFromLogs();
                }
            }, 8000); // Every 8 seconds
        }

        // üîç Extract filters from logs - IMPROVED
        function extractFiltersFromLogs() {
            const bibs = new Set();
            const uuts = new Set();

            allLogLines.forEach(function(line) {
                // Enhanced pattern matching for BIB/UUT extraction
                const patterns = [
                    /(\w+)\/(\w+)/g,  // Standard bib/uut pattern
                    /BIB[_\s]*(\w+)[\/\s]+(\w+)/gi,  // BIB prefix patterns
                    /(\w+)[_\s]*demo\/(\w+)/gi,  // demo patterns
                    /(\w+)[_\s]*test[_\s]*(\w+)/gi  // test patterns
                ];
                
                patterns.forEach(function(pattern) {
                    let match;
                    while ((match = pattern.exec(line)) !== null) {
                        if (match[1] && match[2]) {
                            bibs.add(match[1]);
                            uuts.add(match[2]);
                        }
                    }
                });
            });

            // Update available filters
            availableBibs = bibs;
            availableUuts = uuts;
            updateFilterDropdowns();
        }

        // üîÑ Update filter dropdowns - FIXED
        function updateFilterDropdowns() {
            const bibFilter = document.getElementById('bibFilter');
            const uutFilter = document.getElementById('uutFilter');
            
            // Store current selections
            const currentBib = bibFilter.value;
            const currentUut = uutFilter.value;
            
            // Clear existing options (keep "all")
            bibFilter.innerHTML = '<option value="all">All BIBs</option>';
            uutFilter.innerHTML = '<option value="all">All UUTs</option>';
            
            // Add BIBs
            Array.from(availableBibs).sort().forEach(function(bib) {
                const option = document.createElement('option');
                option.value = bib;
                option.textContent = bib;
                bibFilter.appendChild(option);
            });
            
            // Add UUTs
            Array.from(availableUuts).sort().forEach(function(uut) {
                const option = document.createElement('option');
                option.value = uut;
                option.textContent = uut;
                uutFilter.appendChild(option);
            });
            
            // Restore selections if still valid
            if (currentBib && Array.from(availableBibs).includes(currentBib)) {
                bibFilter.value = currentBib;
            }
            if (currentUut && Array.from(availableUuts).includes(currentUut)) {
                uutFilter.value = currentUut;
            }
        }

        // üéØ Filter logs - COMPLETELY REWRITTEN
        function filterLogs() {
            const bibFilter = document.getElementById('bibFilter').value;
            const uutFilter = document.getElementById('uutFilter').value;
            const levelFilter = document.getElementById('logLevel').value;
            
            // Filter logs based on criteria
            filteredLogLines = allLogLines.filter(function(line) {
                let showLine = true;
                
                // BIB filter
                if (bibFilter !== 'all' && !line.includes(bibFilter)) {
                    showLine = false;
                }
                
                // UUT filter
                if (uutFilter !== 'all' && !line.includes(uutFilter)) {
                    showLine = false;
                }
                
                // Level filter
                if (levelFilter !== 'all' && !line.includes('[' + levelFilter + ']')) {
                    showLine = false;
                }
                
                return showLine;
            });
            
            // Update log display
            updateLogDisplay();
            
            console.log(`üéØ Filtered logs: ${filteredLogLines.length}/${allLogLines.length} lines (BIB: ${bibFilter}, UUT: ${uutFilter}, Level: ${levelFilter})`);
        }

        // üì∫ Update log display
        function updateLogDisplay() {
            const logViewer = document.getElementById('liveLogs');
            logViewer.innerHTML = '';
            
            // Show most recent entries first
            const recentLogs = filteredLogLines.slice(-maxLogLines);
            
            recentLogs.forEach(function(line) {
                addLogLineToDisplay(line);
            });
            
            // Update counter
            document.getElementById('logCount').textContent = filteredLogLines.length;
            
            // Scroll to bottom
            logViewer.scrollTop = logViewer.scrollHeight;
        }

        // ‚ûï Add log line to display
        function addLogLineToDisplay(line) {
            const logViewer = document.getElementById('liveLogs');
            const logDiv = document.createElement('div');
            logDiv.className = 'log-line';
            
            // Style based on content - IMPROVED DETECTION
            if (line.includes('‚úÖ') || line.includes('SUCCESS') || line.includes('[Information]')) {
                logDiv.className += ' log-success';
            } else if (line.includes('‚ö†Ô∏è') || line.includes('WARNING') || line.includes('[Warning]') || line.includes('Slow')) {
                logDiv.className += ' log-warning';
            } else if (line.includes('‚ùå') || line.includes('ERROR') || line.includes('[Error]') || line.includes('FAIL') || line.includes('timeout')) {
                logDiv.className += ' log-error';
            } else if (line.includes('üö®') || line.includes('CRITICAL') || line.includes('[Critical]')) {
                logDiv.className += ' log-error'; // Critical uses error styling
            } else {
                logDiv.className += ' log-info';
            }
            
            logDiv.textContent = line;
            logViewer.appendChild(logDiv);
        }

        // üìà Update metrics from logs - ENHANCED
        function updateMetricsFromLogs() {
            const totalExecutions = allLogLines.filter(line => 
                line.includes('WORKFLOW STARTING') || line.includes('üöÄ')).length;
            
            const successfulExecutions = allLogLines.filter(line => 
                line.includes('COMPLETE: Workflow SUCCESS') || line.includes('‚úÖ COMPLETE')).length;
            
            const failedExecutions = allLogLines.filter(line => 
                line.includes('WORKFLOW EXCEPTION') || line.includes('üí•') || line.includes('FAIL')).length;
            
            const warningExecutions = allLogLines.filter(line => 
                line.includes('[Warning]') || line.includes('‚ö†Ô∏è')).length;
                
            const criticalExecutions = allLogLines.filter(line => 
                line.includes('[Critical]') || line.includes('üö®')).length;
            
            // Calculate success rate
            const successRate = totalExecutions > 0 ? 
                Math.round(((successfulExecutions / totalExecutions) * 100) * 10) / 10 : 0;
            
            // Calculate active BIBs  
            const activeBibs = availableBibs.size;
            
            // Simulate last activity timing
            const lastActivity = allLogLines.length > 0 ? 'Just now' : '-';

            // Update display
            document.getElementById('totalExecutions').textContent = totalExecutions;
            document.getElementById('successRate').textContent = successRate + '%';
            document.getElementById('activeBibs').textContent = activeBibs;
            document.getElementById('lastActivity').textContent = lastActivity;
            
            // Update success rate color
            const successRateElement = document.getElementById('successRate');
            if (successRate >= 95) {
                successRateElement.style.color = '#4CAF50'; // Green
            } else if (successRate >= 85) {
                successRateElement.style.color = '#FF9800'; // Orange
            } else {
                successRateElement.style.color = '#f44336'; // Red
            }
        }

        // üéÆ Control functions
        function clearFilteredLogs() {
            filteredLogLines = [];
            document.getElementById('liveLogs').innerHTML = '<div class="log-line log-info">üìã Logs cleared - use filters to show specific entries</div>';
            document.getElementById('logCount').textContent = '0';
        }

        function clearAllLogs() {
            allLogLines = [];
            filteredLogLines = [];
            availableBibs.clear();
            availableUuts.clear();
            
            document.getElementById('liveLogs').innerHTML = '<div class="log-line log-info">üîç All data cleared - load new log files or sample data</div>';
            document.getElementById('logCount').textContent = '0';
            
            // Reset metrics
            document.getElementById('totalExecutions').textContent = '-';
            document.getElementById('successRate').textContent = '-';
            document.getElementById('activeBibs').textContent = '-';
            document.getElementById('lastActivity').textContent = '-';
            
            // Reset filters
            updateFilterDropdowns();
            updateServiceStatusIndicator('unknown', 'Data cleared - ready for new logs');
            updateFileStatus('üóëÔ∏è All data cleared');
            
            // Stop simulation
            if (simulationTimer) {
                clearInterval(simulationTimer);
                simulationTimer = null;
            }
        }

        function toggleAutoRefresh() {
            autoRefreshEnabled = !autoRefreshEnabled;
            const btn = document.getElementById('refreshBtn');
            btn.textContent = autoRefreshEnabled ? 'Pause' : 'Resume';
            btn.style.backgroundColor = autoRefreshEnabled ? '#2196F3' : '#FF9800';
            
            if (autoRefreshEnabled) {
                refreshCounter = 10;
                if (allLogLines.length > 0 && !simulationTimer) {
                    startSampleSimulation();
                }
            } else {
                if (simulationTimer) {
                    clearInterval(simulationTimer);
                    simulationTimer = null;
                }
            }
        }

        function exportLogs() {
            const logsToExport = filteredLogLines.length > 0 ? filteredLogLines : allLogLines;
            
            if (logsToExport.length === 0) {
                alert('No logs to export. Load some data first.');
                return;
            }
            
            const content = logsToExport.join('\n');
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'serialportpool-logs-' + new Date().toISOString().slice(0,19).replace(/:/g, '-') + '.log';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            updateFileStatus('üíæ Logs exported: ' + logsToExport.length + ' lines');
        }

        // üåê Service connection simulation
        function connectToRealService() {
            const btn = document.getElementById('connectBtn');
            btn.disabled = true;
            btn.textContent = 'Connecting...';
            
            // Simulate connection attempt
            setTimeout(function() {
                serviceConnected = true;
                btn.textContent = 'Connected ‚úì';
                btn.style.backgroundColor = '#4CAF50';
                updateServiceStatusIndicator('running', 'Connected to SerialPortPool service');
                
                // Start real-time updates simulation
                startServiceDataSimulation();
            }, 2000);
        }

        function startServiceDataSimulation() {
            // This would normally connect to actual service endpoints
            setInterval(function() {
                if (serviceConnected && autoRefreshEnabled) {
                    // Simulate service data updates
                    const newActivity = generateServiceActivity();
                    if (newActivity) {
                        allLogLines.push(newActivity);
                        extractFiltersFromLogs();
                        filterLogs();
                        updateMetricsFromLogs();
                    }
                }
            }, 5000);
        }

        function generateServiceActivity() {
            const activities = [
                '[{time}] [Information] üîå Service: Port COM11 allocated to client_demo/production_uut',
                '[{time}] [Information] ‚ö° Service: Execution completed successfully in {duration}s', 
                '[{time}] [Information] üìä Service: System health check - all services nominal',
                '[{time}] [Warning] ‚ö†Ô∏è Service: Port allocation queue building up ({count} pending)',
                '[{time}] [Information] üîÑ Service: Port COM8 released, now available'
            ];
            
            const now = new Date();
            const timeStr = now.toTimeString().slice(0, 12);
            const duration = (Math.random() * 5 + 2).toFixed(1);
            const count = Math.floor(Math.random() * 5) + 1;
            
            return activities[Math.floor(Math.random() * activities.length)]
                .replace('{time}', timeStr)
                .replace('{duration}', duration)
                .replace('{count}', count);
        }

        // üé® UI Helper functions
        function updateServiceStatusIndicator(status, text) {
            const indicator = document.getElementById('serviceIndicator');
            const statusText = document.getElementById('serviceStatus');
            
            indicator.className = 'status-indicator status-' + status;
            statusText.textContent = text;
        }

        function updateFileStatus(message) {
            document.getElementById('fileStatus').textContent = message;
        }

        function refreshServiceData() {
            // This would normally fetch from actual service API
            console.log('üîÑ Refreshing service data...');
        }

        function simulateActivity() {
            // Add a new simulated log entry occasionally
            if (Math.random() < 0.3 && allLogLines.length > 0) { // 30% chance
                const newActivity = generateServiceActivity();
                if (newActivity) {
                    allLogLines.push(newActivity);
                    extractFiltersFromLogs();
                    filterLogs();
                    updateMetricsFromLogs();
                }
            }
        }

        // üö® Error handling
        window.addEventListener('error', function(e) {
            console.error('Dashboard error:', e.error);
            const logViewer = document.getElementById('liveLogs');
            if (logViewer) {
                const errorLog = document.createElement('div');
                errorLog.className = 'log-line log-error';
                errorLog.textContent = '[ERROR] Dashboard: ' + e.error.message;
                logViewer.appendChild(errorLog);
                logViewer.scrollTop = logViewer.scrollHeight;
            }
        });

        // üì± Mobile optimization
        function isMobileDevice() {
            return window.innerWidth <= 768;
        }

        // Adjust for mobile
        if (isMobileDevice()) {
            refreshCounter = 15; // Longer refresh on mobile
            maxLogLines = 100; // Fewer lines on mobile
        }

        console.log('üéØ Dashboard script loaded successfully');
    </script>
</body>
</html>