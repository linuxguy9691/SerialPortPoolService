<?xml version="1.0" encoding="UTF-8"?>
<!-- SerialPortPool-Setup with Custom Action for Service Installation -->
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

  <!-- Product Definition -->
  <Product Id="*" 
           Name="SerialPortPool Service" 
           Language="1033" 
           Version="1.0.0.0" 
           Manufacturer="SerialPortPool Solutions" 
           UpgradeCode="12345678-1234-1234-1234-123456789012">
    
    <Package InstallerVersion="200" 
             Compressed="yes" 
             InstallScope="perMachine"
             Description="Professional serial port pool management service" />

    <!-- Media and Cabinet -->
    <MediaTemplate EmbedCab="yes" />

    <!-- Major Upgrade Logic -->
    <MajorUpgrade DowngradeErrorMessage="A newer version of SerialPortPool is already installed." />

    <!-- Installation Directory Structure -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <!-- Program Files -->
      <Directory Id="ProgramFilesFolder">
        <Directory Id="INSTALLFOLDER" Name="SerialPortPool">
          
          <!-- Main Service Directory -->
          <Directory Id="ServiceDir" Name="Service" />
          
          <!-- Configuration Directory -->
          <Directory Id="ConfigDir" Name="Configuration" />
          
          <!-- Documentation Directory -->
          <Directory Id="DocsDir" Name="Documentation" />
          
          <!-- Scripts Directory -->
          <Directory Id="ScriptsDir" Name="Scripts" />
          
        </Directory>
      </Directory>

      <!-- Logs Directory (C:\Logs\SerialPortPool) -->
      <Directory Id="CommonAppDataFolder">
        <Directory Id="LogsRootDir" Name="Logs">
          <Directory Id="LogsDir" Name="SerialPortPool" />
        </Directory>
      </Directory>
    </Directory>

    <!-- Components with Fixed GUIDs -->
    
    <!-- Main Service Executable Component (NO SERVICE INSTALL HERE) -->
    <Component Id="ServiceExecutable" Guid="A1B2C3D4-E5F6-7890-ABCD-1234567890AB" Directory="ServiceDir">
      <File Id="ServiceExe" 
            Source="$(var.SourceDir)\SerialPortPoolService.exe" 
            KeyPath="yes" />
    </Component>

    <!-- Configuration Files Component -->
    <Component Id="ConfigFiles" Guid="B2C3D4E5-F6A7-8901-BCDE-2345678901BC" Directory="ServiceDir">
      <File Id="NLogConfig" 
            Source="$(var.SourceDir)\NLog.config" 
            KeyPath="yes" />
    </Component>
    
    <!-- Core Library Component -->
    <Component Id="CoreLibrary" Guid="C3D4E5F6-A7B8-9012-CDEF-3456789012CD" Directory="ServiceDir">
      <File Id="CoreDll" 
            Source="$(var.SourceDir)\SerialPortPool.Core.dll" 
            KeyPath="yes" />
    </Component>
    
    <!-- NLog Dependencies Component -->
    <Component Id="NLogDependencies" Guid="D4E5F6A7-B8C9-0123-DEF0-4567890123DE" Directory="ServiceDir">
      <File Id="NLogDll" 
            Source="$(var.SourceDir)\NLog.dll" 
            KeyPath="yes" />
      <File Id="NLogExtensions" 
            Source="$(var.SourceDir)\NLog.Extensions.Logging.dll" />
    </Component>

    <!-- Installation Scripts Component -->
    <Component Id="InstallationScripts" Guid="E5F6A7B8-C9D0-1234-EF01-5678901234EF" Directory="ScriptsDir">
      <File Id="InstallScript" 
            Source="$(var.SourceDir)\Install-Service.ps1" 
            KeyPath="yes" />
      <File Id="UninstallScript" 
            Source="$(var.SourceDir)\Uninstall-Service.ps1" />
    </Component>

    <!-- Default Configuration Component -->
    <Component Id="DefaultConfiguration" Guid="F6A7B8C9-D0E1-2345-F012-6789012345F0" Directory="ConfigDir">
      <File Id="DefaultSettings" 
            Source="$(var.SourceDir)\default-settings.json" 
            KeyPath="yes" />
    </Component>

    <!-- Documentation Component -->
    <Component Id="Documentation" Guid="A7B8C9D0-E1F2-3456-0123-7890123456A0" Directory="DocsDir">
      <File Id="ReadmeMVP" 
            Source="$(var.SourceDir)\README-MVP.txt" 
            KeyPath="yes" />
    </Component>

    <!-- Logs Directory Component -->
    <Component Id="LogsDirectory" Guid="B8C9D0E1-F2A3-4567-1234-8901234567B1" Directory="LogsDir">
      <CreateFolder />
    </Component>

    <!-- Registry Component for Configuration -->
    <Component Id="RegistryEntries" Guid="C9D0E1F2-A3B4-5678-2345-9012345678C2" Directory="TARGETDIR">
      <!-- Installation Path -->
      <RegistryKey Root="HKLM" Key="SOFTWARE\SerialPortPool">
        <RegistryValue Name="InstallPath" 
                       Type="string" 
                       Value="[INSTALLFOLDER]" 
                       KeyPath="yes" />
        <RegistryValue Name="Version" 
                       Type="string" 
                       Value="1.0.0.0" />
        <RegistryValue Name="ServiceName" 
                       Type="string" 
                       Value="SerialPortPoolService" />
      </RegistryKey>
    </Component>

    <!-- Custom Actions for Service Management -->
    <CustomAction Id="InstallService" 
                  Directory="ScriptsDir" 
                  ExeCommand="powershell.exe -ExecutionPolicy Bypass -File &quot;Install-Service.ps1&quot; -ServicePath &quot;[ServiceDir]SerialPortPoolService.exe&quot;" 
                  Execute="deferred" 
                  Impersonate="no" 
                  Return="check" />

    <CustomAction Id="UninstallService" 
                  Directory="ScriptsDir" 
                  ExeCommand="powershell.exe -ExecutionPolicy Bypass -File &quot;Uninstall-Service.ps1&quot;" 
                  Execute="deferred" 
                  Impersonate="no" 
                  Return="ignore" />

    <!-- Install Sequence -->
    <InstallExecuteSequence>
      <Custom Action="InstallService" After="InstallFiles">NOT Installed</Custom>
      <Custom Action="UninstallService" After="InstallInitialize">REMOVE="ALL"</Custom>
    </InstallExecuteSequence>

    <!-- Features -->
    <Feature Id="MainFeature" 
             Title="SerialPortPool Service" 
             Description="Core service and components" 
             Level="1"
             ConfigurableDirectory="INSTALLFOLDER">
      <ComponentRef Id="ServiceExecutable" />
      <ComponentRef Id="ConfigFiles" />
      <ComponentRef Id="CoreLibrary" />
      <ComponentRef Id="NLogDependencies" />
      <ComponentRef Id="InstallationScripts" />
      <ComponentRef Id="LogsDirectory" />
      <ComponentRef Id="RegistryEntries" />
    </Feature>

    <Feature Id="ConfigurationFeature" 
             Title="Configuration Files" 
             Description="Default configuration templates" 
             Level="1">
      <ComponentRef Id="DefaultConfiguration" />
    </Feature>

    <Feature Id="DocumentationFeature" 
             Title="Documentation" 
             Description="User guides and documentation" 
             Level="1">
      <ComponentRef Id="Documentation" />
    </Feature>

    <!-- Simplified Conditions -->
    <Condition Message="This application requires Windows 8.1 or later.">
      <![CDATA[Installed OR (VersionNT >= 603)]]>
    </Condition>

  </Product>
</Wix>